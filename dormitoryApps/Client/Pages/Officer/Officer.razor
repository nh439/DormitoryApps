@page "/Officer"
@using dormitoryApps.Client.Services;
@using Blazored.SessionStorage;
@using Blazored.LocalStorage;
@inject OfficerServices officerServices;
@inject SweetAlertService Swal;
@inject ISessionStorageService sessionStorageService;
@inject SessionServices sessionServices;
@inject ILocalStorageService _localStorageService;
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css"> 
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
<link href="~/Content/sweetalert/sweet-alert.css" rel="stylesheet" /> 
@inject IJSRuntime js
@inject NavigationManager navigationManager;

<center>
    <h1>ระบบเจ้าหน้าที่</h1>
</center>
<br />
<br />
<center>
<form style="" >
    <div style="width:60%">
  <div class="form-group row">
    <label for="text" class="col-4 col-form-label">ชื่อผู้ใช้ หรือ Email</label> 
    <div class="col-8">
      <div class="input-group">
        <div class="input-group-prepend">
          <div class="input-group-text">
            <i class="fa fa-address-card"></i>
          </div>
        </div> 
        <input id="user" @bind="@Username" type="text" @oninput="@(val=> Username=(string)val.Value)" class="form-control @(userrequired ? "is-invalid":"")">
      </div>
      <small style="display:@(userrequired ? "block":"none");color:red;font-weight:bold">ต้องกรอกชื่อผู้ใช้</small>
    </div>
  </div>
  <div class="form-group row">
    <label for="text1" class="col-4 col-form-label">รหัสผ่าน</label> 
    <div class="col-8">
      <div class="input-group">
        <div class="input-group-prepend">
          <div class="input-group-text">
            <i class="fa fa-key"></i>
          </div>
        </div> 
        <input id="pass" @bind="@Password" @oninput="@(val=> Password=(string)val.Value)" type="password" class="form-control @(passrequired ? "is-invalid":"")">
      </div>
      <small style="display:@(passrequired ? "block":"none");color:red;font-weight:bold">ต้องกรอกรหัสผ่าน</small>
    </div>
  </div> 
  <div class="form-group row">
    <div class="offset-4 col-8">
      <button name="submit" type="button" @onclick="Usersubmit" class="btn btn-primary">เข้าใช้งาน</button>
      <button name="submit" type="button" onclick="window.location.href='/Officer/Registerd'" class="btn btn-secondary">ลงทะเบียน</button>
    </div>
     <div class="offset-4 col-8">
    <a class="btn btn-link" href="/ForgotPassword" >ลืมรหัสผ่าน</a>
    </div>
  </div>
  </div>
</form>
</center>

<dormitoryApps.Client.Pages.Officer.Modal.Incomplete @ref="modal">

</dormitoryApps.Client.Pages.Officer.Modal.Incomplete>
<dormitoryApps.Client.Pages.Modal.Auto @ref="auto"/>


@code {
    ElementReference Logging;
    private dormitoryApps.Client.Pages.Officer.Modal.Incomplete modal{ get; set; }
    dormitoryApps.Client.Pages.Modal.Auto auto;
    dormitoryApps.Client.Pages.Modal.Processing processing;
    public string Username { get; set; }
    public string Password { get; set; }
    string Logclass = "display:none";
    bool passrequired = false;
    bool userrequired = false;
    private async void Usersubmit()
    {
        processing.Detail = "Logging In";
        Logclass = "display:block";
        userrequired = string.IsNullOrEmpty(Username);
        passrequired = string.IsNullOrEmpty(Password);
        if(userrequired || passrequired)
        {
            await InvokeAsync(StateHasChanged);
            return;
        }
        //processing.Open();
        auto.Open("Logging In");
        await Task.Delay(1);
        var res = await officerServices.GetLogin(username: Username, password: Password);
        Console.WriteLine(res);
        if(!res)
        {
            /*
            processing.Close();
             await Task.Delay(100);
            modal.IsExpired = false;
            modal.Open();
            */
            auto.Failed("Username Or Password Incorrect", "!Oops!");
            await Task.Delay(1);
            return;
        }      
        var currentUser = await officerServices.GetByUsername(Username);
        if(currentUser.Expired && !currentUser.Issuper)
        {
            /* processing.Close();
             await Task.Delay(100);
             modal.IsExpired = true;
             modal.Open();*/
            auto.Failed("Username Is Expired", "!Oops!");
            await Task.Delay(1);
            return;
        }
        string sessionId = await sessionServices.CreateLogin(currentUser.Id);
        await sessionStorageService.SetItemAsStringAsync("Id", sessionId);
        await _localStorageService.SetItemAsStringAsync("Id", sessionId);
        // processing.Close();
        auto.Close();
        await Task.Delay(1);
        navigationManager.NavigateTo("/",true);

    }
    private async void PassInc()
    {
         Console.WriteLine(Swal);
            await Swal.FireAsync("Hello world!");
    }
}
<dormitoryApps.Client.Pages.Modal.Processing @ref="processing"></dormitoryApps.Client.Pages.Modal.Processing>

